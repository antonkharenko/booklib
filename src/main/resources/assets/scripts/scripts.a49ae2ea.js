"use strict";angular.module("booklibServices",["ngResource"]),angular.module("booklibControllers",[]),angular.module("booklibDirectives",[]);var booklibApp=angular.module("booklibApp",["booklibServices","booklibControllers","ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap","base64","LocalStorageModule","angucomplete","config"]);booklibApp.service("BooklibStorage",["localStorageService",function(a){const b="user";return{getUser:function(){return a.get(b)},setUser:function(c){a.set(b,c)},clear:function(){a.remove(b)}}}]),booklibApp.config(["$routeProvider","$httpProvider",function(a,b){b.defaults.useXDomain=!0,b.defaults.withCredentials=!0,a.when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/signup",{templateUrl:"views/signup.html",controller:"SignUpCtrl"}).when("/dashboard/:username",{templateUrl:"views/dashboard.html",controller:"DashboardCtrl"}).when("/404",{templateUrl:"404.html"}).otherwise({redirectTo:"/login"})}]).run(["BooklibStorage","$rootScope","$location",function(a,b,c){b.$on("$routeChangeStart",function(b,d,e){null==a.getUser()&&("views/login.html"===d.$$route.templateUrl||"views/signup.html"===d.$$route.templateUrl||c.path("/login"))})}]),angular.module("config",[]).constant("ENV","production").constant("API_URL","http://localhost:8080/api");var booklibControllers=angular.module("booklibControllers");booklibControllers.controller("LoginCtrl",["$scope","AccountService","$location",function(a,b,c){a.loginRequest={},a.error="",a.login=function(){b.login(a.loginRequest).success(function(b){a.error="",c.path("/dashboard/"+b.username)}).error(function(b){a.error=b})}}]);var booklibControllers=angular.module("booklibControllers");booklibControllers.controller("SignUpCtrl",["$scope","AccountService","$log","$location",function(a,b,c,d){a.signUpRequest={},a.error="",a.signUp=function(){b.signUp(a.signUpRequest).success(function(b){a.error="",d.path("/dashboard/"+b.username)}).error(function(b){a.error=b})}}]);var booklibControllers=angular.module("booklibControllers");booklibControllers.controller("DashboardCtrl",["$scope","$log","AccountService",function(a,b,c){b.debug("Show dashboard for: "+JSON.stringify(c.getUser())),a.user=c.getUser(),a.username=a.user.username,a.searchBook={}}]);var booklibControllers=angular.module("booklibControllers");booklibControllers.controller("UsermenuCtrl",["$scope","$log","$location","AccountService",function(a,b,c,d){a.user=d.getUser(),a.logout=function(){d.logout()}}]);var booklibServices=angular.module("booklibServices");booklibServices.service("AuthenticationService",["$log","localStorageService","$base64","$q","API_URL",function(a,b,c,d,e){function f(){b.remove(i),b.remove(h)}function g(a,d){b.set(h,a),b.set(i,"Basic "+c.encode(d+":"))}var h="username",i="auth",j=e+"/account/login";this.requiresAuthentication=function(a){return 0===a.lastIndexOf(e,0)},this.getUsername=function(){return b.get(h,username)},this.getAuth=function(){return b.get(i)},this.isAuthenticated=function(){var a=this.getAuth();return"undefined"!=typeof a&&null!==a},this.performLogin=function(b,c){var e=d.defer(),h=e.promise;h.then(function(a){g(a.username,a.api_key)},function(){f()});var i=new XMLHttpRequest;i.open("POST",j,!0),i.setRequestHeader("Accept","application/json"),i.setRequestHeader("Content-Type","application/json"),i.onload=function(){200===this.status?e.resolve(JSON.parse(this.responseText)):401===this.status?e.reject(JSON.parse(this.responseText).message):(a.error("Failed to authenticate: "+JSON.stringify(this)),e.reject("Unexpected server error: ["+this.status+"] "+this.statusText))},i.onerror=function(b){2===b.eventPhase&&(a.error("Failed to reach server at: "+loginUrl),e.reject("Failed to reach server at: "+loginUrl))};var k={login:b,password:c};return i.send(JSON.stringify(k)),h},this.logout=function(){f()}}]),booklibServices.factory("BasicAuthenticationInterceptor",["AuthenticationService","$log",function(a,b){var c={};return c.request=function(c){return a.requiresAuthentication(c.url)&&a.isAuthenticated()&&(b.debug("BasicAuthenticationInterceptor caught:"+JSON.stringify(c)),b.debug("Authorization: "+a.getAuth()),c.headers.Authorization=a.getAuth()),c},c}]),booklibServices.config(["$httpProvider",function(a){a.interceptors.push("BasicAuthenticationInterceptor")}]);var booklibServices=angular.module("booklibServices");booklibServices.service("AccountService",["$http","$log","$location","AuthenticationService","BooklibStorage","API_URL",function(a,b,c,d,e,f){this.login=function(a){b.debug("Send login request: "+a);var c=d.performLogin(a.login,a.password);return c.success=function(a){return c.then(function(c){b.debug("Login successful: "+c),e.setUser(c),a(c)}),c},c.error=function(a){return c.then(null,function(c){b.debug("Login failed: "+c),a(c)}),c},c},this.signUp=function(c){b.debug("Send sign up request: "+c);var d=a.post(f+"/account/signup",c),e={};return e.success=function(a){return d.success(function(c,d,e,f){b.debug("Sign up successful: "+c),a(c)}),e},e.error=function(a){return d.error(function(c,d,e,f){var g;g=c.message?c.message:c.errors?c.errors.join("<br/>"):"Failed to signup user. Please try again later",b.debug("Sign up failed: "+g),a(g)}),e},e},this.logout=function(){b.debug("Log out user");var g=a.post(f+"/account/logout");g.success(function(a,f,g,h){b.debug("Log out successful"),d.logout(),e.clear(),c.path("/login")}),g.error(function(a,f,g,h){b.error("Log out failed: "+a),d.logout(),e.clear(),c.path("/login")})},this.getUser=function(){return e.getUser()}}]),angular.module("angucomplete",["config"]).directive("angucomplete",["$parse","$http","$sce","$timeout","API_URL",function(a,b,c,d,e){return{restrict:"EA",scope:{id:"@id",placeholder:"@placeholder",selectedObject:"=selectedobject",url:"@url",dataField:"@datafield",titleField:"@titlefield",descriptionField:"@descriptionfield",imageField:"@imagefield",imageUri:"@imageuri",inputClass:"@inputclass",userPause:"@pause",localData:"=localdata",searchFields:"@searchfields",minLengthUser:"@minlength",matchClass:"@matchclass"},templateUrl:"views/books_search.html",link:function(a,f,g){a.lastSearchTerm=null,a.currentIndex=null,a.justChanged=!1,a.searchTimer=null,a.hideTimer=null,a.searching=!1,a.pause=500,a.minLength=3,a.searchStr=null,a.minLengthUser&&""!=a.minLengthUser&&(a.minLength=a.minLengthUser),a.userPause&&(a.pause=a.userPause),isNewSearchNeeded=function(b,c){return b.length>=a.minLength&&b!=c},a.processResults=function(b,d){if(b&&b.length>0){a.results=[];var e=[];a.titleField&&""!=a.titleField&&(e=a.titleField.split(","));for(var f=0;f<b.length;f++){for(var g=[],h=0;h<e.length;h++)g.push(b[f][e[h]]);var i="";a.descriptionField&&(i=b[f][a.descriptionField]);var j="";a.imageUri&&(j=a.imageUri);var k="";if(a.imageField){var l=a.imageField.split(".");if(l&&l.length>1){var m,n=b[f],o=l.length;for(m=0;o>m;m++)n=n[l[m]];k=j+n}else k=j+b[f][a.imageField]}var p=g.join(" ");if(a.matchClass){var q=new RegExp(d,"i"),r=p.match(q)[0];p=c.trustAsHtml(p.replace(q,'<span class="'+a.matchClass+'">'+r+"</span>"))}var s={title:p,description:i,image:k,originalObject:b[f]};a.results[a.results.length]=s}}else a.results=[]},a.searchTimerComplete=function(c){if(c.length>=a.minLength)if(a.localData){for(var d=a.searchFields.split(","),f=[],g=0;g<a.localData.length;g++){for(var h=!1,i=0;i<d.length;i++)h=h||"string"==typeof a.localData[g][d[i]]&&"string"==typeof c&&a.localData[g][d[i]].toLowerCase().indexOf(c.toLowerCase())>=0;h&&(f[f.length]=a.localData[g])}a.searching=!1,a.processResults(f,c)}else b.get(e+"/books/search?q="+c,{}).success(function(b,d,e,f){a.searching=!1,a.processResults(a.dataField?b[a.dataField]:b,c)}).error(function(a,b,c,d){console.log("error")})},a.hideResults=function(){a.hideTimer=d(function(){a.showDropdown=!1},a.pause)},a.resetHideResults=function(){a.hideTimer&&d.cancel(a.hideTimer)},a.hoverRow=function(b){a.currentIndex=b},a.keyPressed=function(b){38!=b.which&&40!=b.which&&13!=b.which?a.searchStr&&""!=a.searchStr?isNewSearchNeeded(a.searchStr,a.lastSearchTerm)&&(a.lastSearchTerm=a.searchStr,a.showDropdown=!0,a.currentIndex=-1,a.results=[],a.searchTimer&&d.cancel(a.searchTimer),a.searching=!0,a.searchTimer=d(function(){a.searchTimerComplete(a.searchStr)},a.pause)):(a.showDropdown=!1,a.lastSearchTerm=null):b.preventDefault()},a.selectResult=function(b){a.matchClass&&(b.title=b.title.toString().replace(/(<([^>]+)>)/gi,"")),a.searchStr=a.lastSearchTerm=b.title,a.selectedObject=b,a.showDropdown=!1,a.results=[]};var h=f.find("input");h.on("keyup",a.keyPressed),f.on("keyup",function(b){40===b.which?(a.results&&a.currentIndex+1<a.results.length&&(a.currentIndex++,a.$apply(),b.preventDefault,b.stopPropagation()),a.$apply()):38==b.which?a.currentIndex>=1&&(a.currentIndex--,a.$apply(),b.preventDefault,b.stopPropagation()):13==b.which?a.results&&a.currentIndex>=0&&a.currentIndex<a.results.length?(a.selectResult(a.results[a.currentIndex]),a.$apply(),b.preventDefault,b.stopPropagation()):(a.results=[],a.$apply(),b.preventDefault,b.stopPropagation()):27==b.which?(a.results=[],a.showDropdown=!1,a.$apply()):8==b.which&&(a.selectedObject=null,a.$apply())})}}}]);